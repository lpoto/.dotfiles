#!/bin/sh
#
# This script will build tmux from source and install it to
# ./.build/tmux.
# This script may also be run to update and already built tmux
# installation.

set -e

cur_pwd=${PWD}

if [ "$USER" = "root" ]; then
  echo "==> WARN: This should not be run as root."
  exit 2
fi

echo "==> Checking prerequisites ..."
echo
do_exit=false
for cmd in make automake autoconf pkg-config gcc; do
  if ! command -v $cmd >/dev/null 2>&1; then
    echo "==> ERROR: '$cmd' is not installed."
    do_exit=true
  else
    echo "==> '$cmd' is installed."
  fi
done
if [ "$do_exit" = true ]; then
  echo
  echo "==> Please install the required executables and try again."
  exit 1
fi
echo
echo "==> This script requires 'libevent', 'ncurses' and 'utf8proc' to be installed."
echo
sleep 2

cd "$(dirname "$0")"
scripts=$PWD
cd ../../

if [ -d "./.build/tmux" ]; then
  echo "==> ./.build/tmux exists, pulling latest version ..."
  echo
  sleep 1
  cd ./.build/tmux
  git pull
else
  echo "==> ./.build/tmux does not exist, cloning ..."
  echo
  sleep 1
  git clone --depth 1 https://github.com/tmux/tmux.git .build/tmux
  cd ./.build/tmux
fi

echo
echo "==> Starting build ..."
echo
sleep 2
sh autogen.sh
./configure --prefix=${PWD}/build --enable-utf8proc
make

echo
echo "==> Build complete. (run '${scripts}/tmux' to update tmux)"

cd ${cur_pwd}
